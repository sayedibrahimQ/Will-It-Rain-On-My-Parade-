{% extends 'base.html' %}
{% block content %}
<div class="dashboard-wrapper">
    <div class="animate-fadeIn">

        <!-- Header -->
        <div class="animated-section flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white">Event Day Dashboard</h1>
                <p class="text-slate-400 mt-1">Planning for <span class="text-sky-400 font-semibold">{{ date }}</span> in <span class="text-sky-400 font-semibold">{{ city }}</span></p>
            </div>
        </div>

        <!-- Main Weather Overview -->
        <div class="animated-section bg-gradient-to-br from-sky-800/50 to-indigo-900/50 backdrop-blur-sm p-6 sm:p-8 rounded-2xl mb-8 flex flex-col sm:flex-row items-center justify-between gap-6 border border-sky-700/50 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
            <div class="flex items-center gap-4">
                {% if 'Cloud' in data.main_overview.condition %}
                    <i data-lucide="cloud-sun" class="h-16 w-16 text-yellow-300 pulse-animation"></i>
                {% elif 'Rain' in data.main_overview.condition %}
                    <i data-lucide="cloud-rain" class="h-16 w-16 text-blue-300"></i>
                {% else %}
                    <i data-lucide="sun" class="h-16 w-16 text-yellow-400 pulse-animation"></i>
                {% endif %}
                <div>
                    <p class="text-5xl font-bold text-white">{{ data.main_overview.current_temp }}°C</p>
                    <p class="text-slate-300">{{ data.main_overview.condition }}</p>
                </div>
            </div>
            <div class="text-center sm:text-right">
                <p class="text-lg font-semibold text-white">High: {{ data.main_overview.high_temp }}°C / Low: {{ data.main_overview.low_temp }}°C</p>
                <p class="text-slate-300">Feels like: {{ data.main_overview.feels_like }}°C</p>
                <p class="text-slate-300 mt-1">Chance of rain: <span class="font-semibold">{{ data.main_overview.rain_chance }}%</span></p>
            </div>
        </div>

        <!-- Hourly Forecast -->
        <div class="animated-section mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Hourly Forecast</h2>
            <div class="card-base">
                <canvas id="hourly-forecast-chart"></canvas>
            </div>
        </div>

        <!-- Detailed Metrics -->
        <div class="animated-section mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Detailed Metrics</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <div class="card-base text-center">
                    <i data-lucide="umbrella" class="h-8 w-8 text-blue-400 mx-auto mb-2"></i>
                    <p class="text-slate-400 text-sm">Precipitation</p>
                    <p class="text-white text-xl font-bold">{{ data.detailed_metrics.precipitation_mm }} mm</p>
                </div>
                <div class="card-base text-center">
                    <i data-lucide="droplets" class="h-8 w-8 text-green-400 mx-auto mb-2"></i>
                    <p class="text-slate-400 text-sm">Humidity</p>
                    <p class="text-white text-xl font-bold">{{ data.detailed_metrics.humidity_percent }}%</p>
                </div>
                <div class="card-base text-center">
                    <i data-lucide="wind" class="h-8 w-8 text-yellow-400 mx-auto mb-2"></i>
                    <p class="text-slate-400 text-sm">Wind Speed</p>
                    <p class="text-white text-xl font-bold">{{ data.detailed_metrics.wind_speed_kmh }} km/h</p>
                </div>
                <div class="card-base text-center">
                    <i data-lucide="sun" class="h-8 w-8 text-orange-400 mx-auto mb-2"></i>
                    <p class="text-slate-400 text-sm">UV Index</p>
                    <p class="text-white text-xl font-bold">{{ data.detailed_metrics.uv_index }} ({{ data.detailed_metrics.uv_index_text }})</p>
                </div>
                <div class="card-base text-center">
                    <i data-lucide="eye" class="h-8 w-8 text-purple-400 mx-auto mb-2"></i>
                    <p class="text-slate-400 text-sm">Visibility</p>
                    <p class="text-white text-xl font-bold">{{ data.detailed_metrics.visibility_km }} km</p>
                </div>
            </div>
        </div>

        <!-- Plan Your Day -->
        <div class="animated-section mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Plan Your Day</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-base">
                    <h3 class="font-bold text-white text-lg mb-3 flex items-center gap-2"><i data-lucide="shirt" class="h-5 w-5 text-sky-400"></i> What to Wear</h3>
                    <div class="flex items-center justify-around text-center">
                        {% for item in data.plan_your_day.what_to_wear %}
                        <div><i data-lucide="{{ item.icon }}" class="h-10 w-10 {{ item.color }} mx-auto"></i><p class="text-sm mt-1">{{ item.name }}</p></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-base">
                    <h3 class="font-bold text-white text-lg mb-3 flex items-center gap-2"><i data-lucide="calendar-check" class="h-5 w-5 text-sky-400"></i> Activity Planner</h3>
                    <ul class="space-y-2 text-slate-300">
                        {% for activity in data.plan_your_day.activity_planner %}
                        <li class="flex items-start gap-2"><i data-lucide="{{ activity.icon }}" class="h-5 w-5 {{ activity.color }} flex-shrink-0 mt-1"></i><span><span class="font-semibold">{{ activity.time_period }}:</span> {{ activity.advice }}</span></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Historical Comparison -->
        <div class="animated-section">
            <h2 class="text-2xl font-bold text-white mb-4">Historical Context</h2>
            <div class="card-base">
                <canvas id="historical-chart"></canvas>
            </div>
        </div>
    </div>
</div>

{{ hourly_chart_data|json_script:"hourly-chart-data" }}
{{ historical_chart_data|json_script:"historical-chart-data" }}

<style>
    .dashboard-wrapper {
        background: linear-gradient(-45deg, #1e293b, #0f172a, #1e293b, #334155);
        background-size: 400% 400%;
        animation: gradientBG 20s ease infinite;
        padding: 1.5rem; /* p-6 */
        margin: -1.5rem; /* cancel out parent padding if any */
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .card-base {
        background-color: rgba(30, 41, 59, 0.3); /* bg-slate-800/30 */
        backdrop-filter: blur(4px);
        border: 1px solid rgb(51 65 85); /* border-slate-700 */
        border-radius: 1rem; /* rounded-2xl */
        padding: 1.5rem; /* p-6 */
        transition: all 0.3s ease-in-out;
    }

    .card-base:hover {
        background-color: rgba(51, 65, 85, 0.5); /* hover:bg-slate-700/50 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: translateY(-4px);
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animated-section {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .pulse-animation {
        animation: pulse 3s infinite ease-in-out;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
        50% { transform: scale(1.1); box-shadow: 0 0 10px 10px rgba(252, 211, 77, 0); }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const chartTextColor = '#94a3b8'; // text-slate-400
    const chartGridColor = 'rgba(148, 163, 184, 0.1)';

    // Staggered animations
    const sections = document.querySelectorAll('.animated-section');
    sections.forEach((section, index) => {
        section.style.animationDelay = `${index * 0.15}s`;
    });

    // Parse data from template
    const hourlyData = JSON.parse(document.getElementById('hourly-chart-data').textContent);
    const historicalData = JSON.parse(document.getElementById('historical-chart-data').textContent);

    // Hourly Forecast Chart
    const hourlyCtx = document.getElementById('hourly-forecast-chart');
    if (hourlyCtx && hourlyData.labels) {
        new Chart(hourlyCtx, {
            type: 'bar',
            data: hourlyData, // Use the data object directly from the backend
            options: {
                responsive: true,
                maintainAspectRatio: false,
                height: 300,
                scales: {
                    x: {
                        ticks: { color: chartTextColor },
                        grid: { color: chartGridColor }
                    },
                    y: {
                        position: 'left',
                        ticks: { color: chartTextColor },
                        grid: { color: chartGridColor },
                        title: { display: true, text: 'Temperature (°C)', color: chartTextColor }
                    },
                    y1: {
                        position: 'right',
                        min: 0,
                        max: 100,
                        ticks: { color: chartTextColor, callback: value => value + '%' },
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Rain Chance', color: chartTextColor }
                    }
                },
                plugins: {
                    legend: { labels: { color: chartTextColor } }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
            }
        });
    }

    // Historical Chart
    const historicalCtx = document.getElementById('historical-chart');
    if (historicalCtx && historicalData.labels) {
        new Chart(historicalCtx, {
            type: 'bar',
            data: historicalData, // Use the data object directly from the backend
            options: {
                responsive: true,
                maintainAspectRatio: false,
                height: 300,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: chartTextColor },
                        grid: { color: chartGridColor }
                    },
                    x: {
                        ticks: { color: chartTextColor },
                        grid: { color: chartGridColor }
                    }
                },
                plugins: {
                    legend: { labels: { color: chartTextColor } },
                    title: {
                        display: true,
                        text: `Temperature vs. Historical Average for ${historicalData.date}`,
                        color: 'white',
                        font: { size: 16 }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}